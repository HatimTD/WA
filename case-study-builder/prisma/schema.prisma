generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(CONTRIBUTOR)
  region        String?
  totalPoints   Int       @default(0)
  badges        Badge[]

  // User Preferences
  notificationPreferences Json?     @default("{\"inAppNotifications\":true,\"emailNotifications\":true,\"caseApprovalNotif\":true,\"caseRejectionNotif\":true,\"newCommentNotif\":true,\"bhagMilestones\":true,\"inAppCaseApproval\":true,\"inAppCaseRejection\":true,\"inAppNewComment\":true,\"inAppBhagMilestones\":true}")
  displayPreferences      Json?     @default("{\"theme\":\"system\",\"resultsPerPage\":10,\"defaultView\":\"grid\"}")

  // Relations
  caseStudies   CaseStudy[] @relation("Contributor")
  approvals     CaseStudy[] @relation("Approver")
  rejectedCases CaseStudy[] @relation("Rejector")
  comments      Comment[]
  savedCases    SavedCase[]
  notifications Notification[]
  accounts      Account[]
  sessions      Session[]

  // Soft delete support (WA Policy Section 5.1)
  isActive      Boolean   @default(true)
  deletedAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  CONTRIBUTOR
  APPROVER
  ADMIN
  VIEWER
}

enum Badge {
  EXPLORER    // 10 Application Case Studies
  EXPERT      // 10 Tech Case Studies
  CHAMPION    // 10 Star Case Studies
}

model CaseStudy {
  id                      String    @id @default(cuid())
  type                    CaseType  @default(APPLICATION)
  status                  Status    @default(DRAFT)

  // Contributors & Approval
  contributorId           String
  contributor             User      @relation("Contributor", fields: [contributorId], references: [id])
  approverId              String?
  approver                User?     @relation("Approver", fields: [approverId], references: [id])
  submittedAt             DateTime?
  approvedAt              DateTime?

  // Rejection Tracking
  rejectionReason         String?   @db.Text
  rejectedAt              DateTime?
  rejectedBy              String?
  rejector                User?     @relation("Rejector", fields: [rejectedBy], references: [id])

  // Core Fields
  customerName            String
  industry                String
  componentWorkpiece      String
  workType                WorkType
  wearType                WearType[]
  problemDescription      String    @db.Text
  previousSolution        String?
  previousServiceLife     String?
  competitorName          String?
  baseMetal               String?
  generalDimensions       String?

  // WA Solution
  waSolution              String
  waProduct               String
  technicalAdvantages     String?   @db.Text
  expectedServiceLife     String?
  solutionValueRevenue    Decimal?  @db.Decimal(12,2)
  annualPotentialRevenue  Decimal?  @db.Decimal(12,2)
  customerSavingsAmount   Decimal?  @db.Decimal(12,2)

  // Location
  location                String
  country                 String?

  // Media
  images                  String[]
  supportingDocs          String[]

  // Tags for AI-powered search
  tags                    String[]  @default([])

  // Translation
  originalLanguage        String    @default("en")
  translationAvailable    Boolean   @default(false)
  translatedText          String?   @db.Text

  // Relations
  wps                     WeldingProcedure?
  costCalculator          CostCalculator?
  comments                Comment[]
  savedBy                 SavedCase[]

  // Soft delete support (WA Policy Section 5.1)
  isActive                Boolean   @default(true)
  deletedAt               DateTime?
  deletedBy               String?

  // Metadata
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@unique([customerName, location, componentWorkpiece, waProduct], name: "unique_challenge")
  @@index([status, type])
  @@index([industry, componentWorkpiece])
  @@index([contributorId])
}

enum CaseType {
  APPLICATION  // 1 point
  TECH         // 2 points
  STAR         // 3 points
}

enum Status {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PUBLISHED
}

enum WorkType {
  WORKSHOP
  ON_SITE
  BOTH
}

enum WearType {
  ABRASION
  IMPACT
  CORROSION
  TEMPERATURE
  COMBINATION
}

model WeldingProcedure {
  id                    String    @id @default(cuid())
  caseStudyId           String    @unique
  caseStudy             CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  // Base Metal
  baseMetalType         String?
  baseMetalGrade        String?
  baseMetalThickness    String?
  surfacePreparation    String?

  // WA Product
  waProductName         String
  waProductDiameter     String?
  shieldingGas          String?
  shieldingFlowRate     String?
  flux                  String?
  standardDesignation   String?

  // Welding Parameters
  weldingProcess        String
  currentType           String?
  currentModeSynergy    String?
  wireFeedSpeed         String?
  intensity             String?
  voltage               String?
  heatInput             String?
  weldingPosition       String?
  torchAngle            String?
  stickOut              String?
  travelSpeed           String?

  // Oscillation
  oscillationWidth      String?
  oscillationSpeed      String?
  oscillationStepOver   String?
  oscillationTempo      String?

  // Temperature
  preheatTemperature    String?
  interpassTemperature  String?
  postheatTemperature   String?
  pwhtDetails           String?

  // Results
  layerNumbers          Int?
  hardness              String?
  defectsObserved       String?
  additionalNotes       String?   @db.Text

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model CostCalculator {
  id                          String    @id @default(cuid())
  caseStudyId                 String    @unique
  caseStudy                   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  // Material Costs
  materialCostBefore          Float
  materialCostAfter           Float

  // Labor Costs
  laborCostBefore             Float
  laborCostAfter              Float

  // Downtime Costs
  downtimeCostBefore          Float
  downtimeCostAfter           Float

  // Maintenance Frequency
  maintenanceFrequencyBefore  Int
  maintenanceFrequencyAfter   Int

  // NEW FIELDS (BRD Rows 28-33, 38)
  costOfPart                  Float?    @default(0)
  oldSolutionLifetimeDays     Int?      @default(0)
  waSolutionLifetimeDays      Int?      @default(0)
  partsUsedPerYear            Int?      @default(0)
  maintenanceRepairCostBefore Float?    @default(0)
  maintenanceRepairCostAfter  Float?    @default(0)
  disassemblyCostBefore       Float?    @default(0)
  disassemblyCostAfter        Float?    @default(0)
  extraBenefits               String?   @db.Text

  // Calculated Totals
  totalCostBefore             Float
  totalCostAfter              Float
  annualSavings               Float
  savingsPercentage           Int

  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
}

model Comment {
  id            String    @id @default(cuid())
  content       String    @db.Text
  caseStudyId   String
  caseStudy     CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  likes         Int       @default(0)

  // Enhanced reactions
  reactions     CommentReaction[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([caseStudyId])
}

model CommentReaction {
  id          String        @id @default(cuid())
  commentId   String
  comment     Comment       @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId      String
  type        ReactionType
  createdAt   DateTime      @default(now())

  @@unique([commentId, userId, type])
  @@index([commentId])
}

enum ReactionType {
  LIKE      // üëç
  LOVE      // ‚ù§Ô∏è
  CELEBRATE // üéâ
  INSIGHTFUL // üí°
  HELPFUL   // üôå
  THUMBS_DOWN // üëé
}

enum NotificationType {
  CASE_APPROVED
  CASE_REJECTED
  NEW_COMMENT
  BADGE_EARNED
  BHAG_MILESTONE
  SYSTEM_ANNOUNCEMENT
}

model SavedCase {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseStudyId String
  caseStudy   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@unique([userId, caseStudyId])
  @@index([userId])
  @@index([caseStudyId])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?

  createdAt DateTime @default(now())
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String           @db.Text
  read      Boolean          @default(false)
  link      String?

  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

model EmailTemplate {
  id          String              @id @default(cuid())
  name        String
  type        EmailTemplateType
  subject     String
  htmlContent String              @db.Text
  textContent String?             @db.Text
  logoUrl     String?
  isActive    Boolean             @default(true)
  variables   String[]            // List of available variables like {{userName}}, {{caseTitle}}

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([type])
}

enum EmailTemplateType {
  CASE_APPROVED
  CASE_REJECTED
  NEW_COMMENT
  BADGE_EARNED
  BHAG_MILESTONE
  WELCOME
  SYSTEM_ANNOUNCEMENT
}
