generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

// =====================================================
// NEXTAUTH.JS STANDARD MODELS (DO NOT RENAME)
// These follow NextAuth.js conventions
// =====================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(CONTRIBUTOR)
  region        String?
  totalPoints   Int       @default(0)
  badges        Badge[]

  // User Preferences
  notificationPreferences Json? @default("{\"inAppNotifications\":true,\"emailNotifications\":true,\"caseApprovalNotif\":true,\"caseRejectionNotif\":true,\"newCommentNotif\":true,\"bhagMilestones\":true,\"inAppCaseApproval\":true,\"inAppCaseRejection\":true,\"inAppNewComment\":true,\"inAppBhagMilestones\":true}")
  displayPreferences      Json? @default("{\"theme\":\"system\",\"resultsPerPage\":10,\"defaultView\":\"grid\"}")

  // Relations
  caseStudies   WaCaseStudy[]    @relation("Contributor")
  approvals     WaCaseStudy[]    @relation("Approver")
  rejectedCases WaCaseStudy[]    @relation("Rejector")
  comments      WaComment[]
  savedCases    WaSavedCase[]
  notifications WaNotification[]
  accounts      Account[]
  sessions      Session[]
  taggedInCases WaCaseStudy[]    @relation("TaggedInCases")

  // Soft delete support (WA Policy Section 5.1)
  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =====================================================
// ENUMS (Keep standard names for compatibility)
// =====================================================

// BRD Section 2.2 - Key Stakeholders/Roles
enum Role {
  CONTRIBUTOR     // Field engineers who submit case studies
  APPROVER        // Technical leads who approve/reject submissions
  ADMIN           // System administrators with full access
  VIEWER          // Read-only access users
  IT_DEPARTMENT   // IT team for system configuration and integration
  MARKETING       // Marketing team for content management and campaigns
}

enum Badge {
  EXPLORER // 10 Application Case Studies
  EXPERT // 10 Tech Case Studies
  CHAMPION // 10 Star Case Studies
}

enum CaseType {
  APPLICATION // 1 point
  TECH // 2 points
  STAR // 3 points
}

// Challenge Qualifier Type (BRD 3.1)
enum QualifierType {
  NEW_CUSTOMER  // No purchase in 3 years - COUNTS toward target
  CROSS_SELL    // Existing customer, new product - COUNTS toward target
  MAINTENANCE   // Existing customer, existing product - NOT counted
}

enum Status {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PUBLISHED
}

enum WorkType {
  WORKSHOP
  ON_SITE
  BOTH
}

enum WearType {
  ABRASION
  IMPACT
  CORROSION
  TEMPERATURE
  COMBINATION
}

enum ReactionType {
  LIKE // üëç
  LOVE // ‚ù§Ô∏è
  CELEBRATE // üéâ
  INSIGHTFUL // üí°
  HELPFUL // üôå
  THUMBS_DOWN // üëé
}

enum NotificationType {
  CASE_APPROVED
  CASE_REJECTED
  NEW_COMMENT
  BADGE_EARNED
  BHAG_MILESTONE
  SYSTEM_ANNOUNCEMENT
}

enum EmailTemplateType {
  CASE_APPROVED
  CASE_REJECTED
  NEW_COMMENT
  BADGE_EARNED
  BHAG_MILESTONE
  WELCOME
  SYSTEM_ANNOUNCEMENT
}

enum AuditActionType {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED

  // Break-Glass (WA Policy Section 3.1)
  BREAK_GLASS_ACCESS
  BREAK_GLASS_ACCESS_FAILED
  BREAK_GLASS_ACTION
  BREAK_GLASS_SESSION_TERMINATED

  // Case Study Actions
  CASE_CREATED
  CASE_UPDATED
  CASE_DELETED
  CASE_SUBMITTED
  CASE_APPROVED
  CASE_REJECTED
  CASE_PUBLISHED

  // User Actions
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ROLE_CHANGED

  // GDPR Actions (WA Policy Section 7.5)
  DATA_EXPORT
  DATA_DELETION_REQUEST
  DATA_ANONYMIZED
  CONSENT_GIVEN
  CONSENT_WITHDRAWN

  // System Actions
  SYSTEM_CONFIG_CHANGED
  BULK_OPERATION
  RETENTION_CLEANUP
}

enum GdprDeletionStatus {
  PENDING           // Request received, awaiting verification
  VERIFIED          // User identity verified
  IN_PROGRESS       // Deletion/anonymization in progress
  COMPLETED         // Successfully processed
  REJECTED          // Request rejected (with reason)
  CANCELLED         // Cancelled by user
}

enum SyncStatus {
  SYNCED
  PENDING
  ERROR
}

enum JobStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// =====================================================
// WA-SPECIFIC MODELS (with Wa prefix)
// Using @@map to keep database table names unchanged
// =====================================================

model WaCaseStudy {
  id     String   @id @default(cuid())
  type   CaseType @default(APPLICATION)
  status Status   @default(DRAFT)

  // Contributors & Approval
  contributorId String
  contributor   User      @relation("Contributor", fields: [contributorId], references: [id])
  approverId    String?
  approver      User?     @relation("Approver", fields: [approverId], references: [id])
  submittedAt   DateTime?
  approvedAt    DateTime?

  // Rejection Tracking
  rejectionReason String?   @db.Text
  rejectedAt      DateTime?
  rejectedBy      String?
  rejector        User?     @relation("Rejector", fields: [rejectedBy], references: [id])

  // Core Fields
  customerName        String
  industry            String
  componentWorkpiece  String
  workType            WorkType
  wearType            WearType[]
  problemDescription  String     @db.Text
  previousSolution    String?
  previousServiceLife String?
  competitorName      String?
  baseMetal           String?
  generalDimensions   String?

  // WA Solution
  waSolution             String
  waProduct              String
  technicalAdvantages    String?  @db.Text
  expectedServiceLife    String?
  solutionValueRevenue   Decimal? @db.Decimal(12, 2)
  annualPotentialRevenue Decimal? @db.Decimal(12, 2)
  customerSavingsAmount  Decimal? @db.Decimal(12, 2)

  // OEM Information (BRD Section 5 - Search Filter)
  oem String?  // Original Equipment Manufacturer

  // Location
  location String
  country  String?

  // Media
  images         String[]
  supportingDocs String[]

  // Tags for AI-powered search
  tags String[] @default([])

  // Translation
  originalLanguage     String  @default("en")
  translationAvailable Boolean @default(false)
  translatedText       String? @db.Text

  // Relations
  wps            WaWeldingProcedure?
  costCalculator WaCostCalculator?
  comments       WaComment[]
  savedBy        WaSavedCase[]
  taggedUsers    User[]            @relation("TaggedInCases")

  // Soft delete support (WA Policy Section 5.1)
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  deletedBy String?

  // NetSuite Integration
  netsuiteCustomerId String?
  netsuiteSyncedAt   DateTime?

  // Insightly CRM Integration (BRD 5.9)
  insightlyOpportunityId Int?
  insightlySyncedAt      DateTime?

  // Challenge Qualifier (BRD 3.1) - Determines if case counts toward 10K target
  qualifierType        QualifierType?
  isTarget             Boolean       @default(false)  // Counts toward BHAG 10,000 goal
  customerLastPurchase DateTime?                      // For 3-year purchase check

  // Flag System (BRD 3.2) - Case Study Tiers
  hasApplicationFlag   Boolean       @default(false)  // General + Problem/Solution filled
  hasWpsFlag           Boolean       @default(false)  // WPS Details filled
  hasCostFlag          Boolean       @default(false)  // Cost Calculator filled

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([customerName, location, componentWorkpiece, waProduct], name: "unique_challenge")
  @@index([status, type])
  @@index([industry, componentWorkpiece])
  @@index([contributorId])
  @@map("CaseStudy")
}

model WaWeldingProcedure {
  id          String       @id @default(cuid())
  caseStudyId String       @unique
  caseStudy   WaCaseStudy  @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  // Base Metal
  baseMetalType      String?
  baseMetalGrade     String?
  baseMetalThickness String?
  surfacePreparation String?

  // WA Product
  waProductName       String
  waProductDiameter   String?
  shieldingGas        String?
  shieldingFlowRate   String?
  flux                String?
  standardDesignation String?

  // Welding Parameters
  weldingProcess     String
  currentType        String?
  currentModeSynergy String?
  wireFeedSpeed      String?
  intensity          String?
  voltage            String?
  heatInput          String?
  weldingPosition    String?
  torchAngle         String?
  stickOut           String?
  travelSpeed        String?

  // Oscillation
  oscillationWidth    String?
  oscillationSpeed    String?
  oscillationStepOver String?
  oscillationTempo    String?

  // Temperature
  preheatTemperature   String?
  interpassTemperature String?
  postheatTemperature  String?
  pwhtDetails          String?

  // Results
  layerNumbers    Int?
  hardness        String?
  defectsObserved String?
  additionalNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("WeldingProcedure")
}

model WaCostCalculator {
  id          String       @id @default(cuid())
  caseStudyId String       @unique
  caseStudy   WaCaseStudy  @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  // Material Costs
  materialCostBefore Float
  materialCostAfter  Float

  // Labor Costs
  laborCostBefore Float
  laborCostAfter  Float

  // Downtime Costs
  downtimeCostBefore Float
  downtimeCostAfter  Float

  // Maintenance Frequency
  maintenanceFrequencyBefore Int
  maintenanceFrequencyAfter  Int

  // NEW FIELDS (BRD Rows 28-33, 38)
  costOfPart                  Float?  @default(0)
  oldSolutionLifetimeDays     Int?    @default(0)
  waSolutionLifetimeDays      Int?    @default(0)
  partsUsedPerYear            Int?    @default(0)
  maintenanceRepairCostBefore Float?  @default(0)
  maintenanceRepairCostAfter  Float?  @default(0)
  disassemblyCostBefore       Float?  @default(0)
  disassemblyCostAfter        Float?  @default(0)
  extraBenefits               String? @db.Text

  // Calculated Totals
  totalCostBefore   Float
  totalCostAfter    Float
  annualSavings     Float
  savingsPercentage Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("CostCalculator")
}

model WaComment {
  id          String       @id @default(cuid())
  content     String       @db.Text
  caseStudyId String
  caseStudy   WaCaseStudy  @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  likes       Int          @default(0)

  // Enhanced reactions
  reactions WaCommentReaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseStudyId])
  @@map("Comment")
}

model WaCommentReaction {
  id        String       @id @default(cuid())
  commentId String
  comment   WaComment    @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())

  @@unique([commentId, userId, type])
  @@index([commentId])
  @@map("CommentReaction")
}

model WaSavedCase {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  caseStudyId String
  caseStudy   WaCaseStudy  @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, caseStudyId])
  @@index([userId])
  @@index([caseStudyId])
  @@map("SavedCase")
}

model WaSystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?

  createdAt DateTime @default(now())

  @@map("SystemConfig")
}

model WaNotification {
  id      String           @id @default(cuid())
  userId  String
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type    NotificationType
  title   String
  message String           @db.Text
  read    Boolean          @default(false)
  link    String?

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
  @@map("Notification")
}

model WaEmailTemplate {
  id          String            @id @default(cuid())
  name        String
  type        EmailTemplateType
  subject     String
  htmlContent String            @db.Text
  textContent String?           @db.Text
  logoUrl     String?
  isActive    Boolean           @default(true)
  variables   String[] // List of available variables like {{userName}}, {{caseTitle}}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type])
  @@map("EmailTemplate")
}

// =====================================================
// IMMUTABLE AUDIT LOG (WA Policy Section 5.2)
// Write-once audit trail with hash verification
// =====================================================
model WaAuditLog {
  id            String   @id @default(cuid())

  // Action details
  actionType    AuditActionType
  userId        String
  userEmail     String

  // Resource information
  resourceId    String?
  resourceType  String?

  // State tracking
  previousState Json?
  newState      Json?

  // Request context
  ipAddress     String?
  userAgent     String?
  sessionId     String?

  // Integrity verification (immutability)
  contentHash   String   // SHA-256 hash of the log content
  previousHash  String?  // Hash of the previous log entry (blockchain-like)

  // Timestamp (immutable)
  createdAt     DateTime @default(now())

  // Indexes for efficient querying
  @@index([userId])
  @@index([resourceId])
  @@index([actionType])
  @@index([createdAt])
  @@index([contentHash])
  @@map("AuditLog")
}

// =====================================================
// DATA RETENTION TRACKING (WA Policy Section 7.5.4)
// Tracks data lifecycle for compliance
// =====================================================
model WaDataRetentionPolicy {
  id                String   @id @default(cuid())
  dataType          String   @unique // e.g., 'User', 'CaseStudy', 'AuditLog'
  retentionDays     Int      // Number of days to retain data
  archiveAfterDays  Int?     // Days before archiving (optional)
  description       String?
  legalBasis        String?  // GDPR legal basis for retention

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("DataRetentionPolicy")
}

// =====================================================
// GDPR DATA DELETION REQUESTS (WA Policy Section 7.5.1)
// Tracks right-to-be-forgotten requests
// =====================================================
model WaGdprDeletionRequest {
  id              String                @id @default(cuid())
  userId          String
  userEmail       String
  status          GdprDeletionStatus    @default(PENDING)

  // Request details
  requestedAt     DateTime              @default(now())
  processedAt     DateTime?
  processedBy     String?

  // Verification
  verificationToken String?             @unique
  verifiedAt      DateTime?

  // Completion tracking
  deletedData     Json?                 // Summary of what was deleted
  anonymizedData  Json?                 // Summary of what was anonymized

  // Notes
  notes           String?               @db.Text

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([userId])
  @@index([status])
  @@map("GdprDeletionRequest")
}

// =====================================================
// NETSUITE CUSTOMER CACHE (BRD 5.9.3)
// Local cache of NetSuite customers for faster search
// =====================================================
model WaNetSuiteCustomerCache {
  id              String   @id @default(cuid())

  // NetSuite identifiers
  netsuiteId      String   @unique  // NetSuite internal ID
  entityId        String?           // NetSuite entity ID (customer code)

  // Customer information
  companyName     String
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?
  industry        String?

  // Contact information
  email           String?
  phone           String?

  // Sync metadata
  lastSyncedAt    DateTime @default(now())
  syncStatus      SyncStatus @default(SYNCED)
  syncError       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyName])
  @@index([city])
  @@index([industry])
  @@index([lastSyncedAt])
  @@map("NetSuiteCustomerCache")
}

// Sync job tracking
model WaNetSuiteSyncJob {
  id              String   @id @default(cuid())

  startedAt       DateTime @default(now())
  completedAt     DateTime?

  status          JobStatus @default(RUNNING)

  // Statistics
  totalRecords    Int      @default(0)
  newRecords      Int      @default(0)
  updatedRecords  Int      @default(0)
  failedRecords   Int      @default(0)

  errorMessage    String?

  createdAt       DateTime @default(now())

  @@index([status])
  @@index([startedAt])
  @@map("NetSuiteSyncJob")
}
